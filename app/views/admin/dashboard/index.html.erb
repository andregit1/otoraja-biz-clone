<% content_for(:title, t('admin.dashboard.dashboard')) %>

<% @available_shop_plan.each do | av_shop | %>
  <% if av_shop.will_run_out? %>
  <div class="alert alert-warning alert-dismissible fade show" role="alert">
    <%= t 'admin.subscription.subscription_expired_alert_html', shop_name: av_shop.name, days_remaining: av_shop.days_remaining %>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <%end %>
<%end%>

<% if @owner_setup_incomplite %>  
  <div class="card card-widget" id="initial-info">
    <div class="card-header color-text-table-header py-3">
      <h3 class="card-title text-uppercase"><%= t 'admin.dashboard.setup_shop' %> <%= @shop.name %></h3>
    </div>
    <div class="card-body px-2">
      <div class="col-12 d-flex mb-4">
        <div>
          <% if @has_initial_shop %>
            <span class="py-2 text-label badge badge-success notif-initial-label">
              <%= t 'admin.dashboard.done' %>
            </span>
          <% else %>
            <span class="py-2 text-label badge badge-danger notif-initial-label">
              <%= t 'admin.dashboard.not_yet' %>
            </span>
          <% end %>
        </div>
        <div class="col-8 col-md-10">
          <p class="text-normal font-weight-bold mb-2"> <%= t 'admin.dashboard.initial_shop' %></p>
          <%= link_to admin_shop_setting_path, class: 'text-small' do%>
            <u><%= t 'admin.dashboard.initial_shop_link' %></u>
          <% end %>
        </div>
      </div>
      <div class="col-12 d-flex mb-4">
        <div>
          <% if @has_initial_staff %>
            <span class="py-2 text-label badge badge-success notif-initial-label">
              <%= t 'admin.dashboard.done' %>
            </span>
          <% else %>
            <span class="py-2 text-label badge badge-danger notif-initial-label">
              <%= t 'admin.dashboard.not_yet' %>
            </span>
          <% end %>
        </div>
        <div class="col-8 col-md-10">
          <p class="text-normal font-weight-bold mb-2"> <%= t 'admin.dashboard.initial_staff' %></p>
          <%= link_to admin_shop_staffs_path, class: 'text-small' do%>
            <u><%= t 'admin.dashboard.initial_staff_link' %></u>
          <% end %>
        </div>
      </div>
      <div class="col-12 d-flex mb-4">
        <div>
          <% if @has_initial_user %>
            <span class="py-2 text-label badge badge-success notif-initial-label">
              <%= t 'admin.dashboard.done' %>
            </span>
          <% else %>
            <span class="py-2 text-label badge badge-danger notif-initial-label">
              <%= t 'admin.dashboard.not_yet' %>
            </span>
          <% end %>
        </div>
        <div class="col-8 col-md-10">
          <p class="text-normal font-weight-bold mb-2"> <%= t 'admin.dashboard.initial_user' %></p>
          <%= link_to admin_users_path, class: 'text-small' do%>
            <u><%= t 'admin.dashboard.initial_user_link' %></u>
          <% end %>
        </div>
      </div>
      <% if @owner_setup_complite %>
      <div class="col-12">
          <p class="text-normal"><%= t 'admin.dashboard.close_info' %></p>
          <%= link_to admin_dashboard_initial_setup_path, method: 'patch', class: 'btn button-tertinary-active' do%>
            <span class="text-large"><%= t 'admin.common.close' %></span>
          <% end %>
        </div>
      <% else %>      
        <div class="col-12 row m-0">
          <div class="col-12 col-md-9">
            <p class="text-normal">
              <%= t 'admin.dashboard.initial_info' %>
            </p>
          </div>
          <div class="col-5 col-md-3">
            <a href="https://play.google.com/store/apps/details?id=id.co.otoraja.otoraja_biz_front_app&pcampaignid=pcampaignidMKT-Other-global-all-co-prtnr-py-PartBadge-Mar2515-1"  target="_blank">
              <%= image_tag 'https://play.google.com/intl/en_us/badges/static/images/badges/id_badge_web_generic.png', height: '100', class: 'img-fluid', alt: 'Temukan di Google Play' %>
            </a>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<%= form_tag({:controller => 'dashboard', :action => 'index'}, :remote => true, :class => 'form-ajax') do %>
  <%= hidden_field_tag :ajax_handler, 'handle_dashboard' %>
  <%= hidden_field_tag :start_date, drpInitialStartDate(), :id => 'start_date' %>
  <%= hidden_field_tag :end_date, drpInitialEndDate(), :id => 'end_date' %>
  <%= hidden_field_tag :dashboard_shop, session[:default_user_shop] %>
  
  <%= submit_tag('Submit', :id => 'dashboard-commit', :style=>"display:none;") %>

  <%= render 'search' %>

  <%# SALES SUMMARY %>
  <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <span class="text-large"> <%= t 'admin.dashboard.sales_summary' %> </span>
      <button class="text-label scroll-up-btn d-flex justify-content-center align-items-center">
        <span class='mr-2 date-range-readonly'></span><i class='fas fa-arrow-up'></i>
      </button>
    </div>

    <div class="loading-wrapper">
      <ul class="nav nav-custome nav-tabs_custome tablist horizontal-scroll-wrapper" id="sales-summary-tabs" role="tablist">
        <li class="nav-item">
          <a class="text-normal font-weight-bold nav-link active" id="revenue-tab" data-toggle="tab" href="#revenue" role="tab" aria-controls="revenue" aria-selected="true"><%= t 'admin.dashboard.revenue' %></a>
        </li>
        <li class="nav-item">
          <a class="text-normal font-weight-bold nav-link" id="sales-tab" data-toggle="tab" href="#sales" role="tab" aria-controls="sales" aria-selected="false"><%= t 'admin.dashboard.sales' %></a>
        </li>
        <li class="nav-item">
          <a class="text-normal font-weight-bold nav-link" id="profit-tab" data-toggle="tab" href="#profit" role="tab" aria-controls="profit" aria-selected="false"><%= t 'admin.dashboard.profit_uppercase' %></a>
        </li>
        <li class="nav-item">
          <a class="text-normal font-weight-bold nav-link" id="expenses-tab" data-toggle="tab" href="#expenses" role="tab" aria-controls="profit" aria-selected="false">Pengeluaran</a>
        </li>
      </ul>
      <div class="tab-content" id="sales-summary-tabs-content">
        <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
          <div class="row pb-5 pt-4">
            <div class="col-8">
              <div class="text-normal"><%= t 'admin.dashboard.total_sales_lowercase' %></div>
              <div id="total-sales" class="text-highlight font-weight-bold mb-0"></div>
            </div>
            <div class="col-4">
              <%= select :sales_aggregation_unit, :type, aggregationUnitArray(), {}, {class: 'form-control unavailable-btn'} %>
            </div>
          </div>
          <div class="pb-5 mb-4">
            <canvas id="salesBarChart" style="height: 350px; width: 100%;" class="chartjs-render-monitor"></canvas>
          </div>
        </div>
        <div class="tab-pane fade show active" id="revenue" role="tabpanel" aria-labelledby="revenue-tab">
          <div class="row pb-5 pt-4">
            <div class="col-8">
              <div class="text-normal"><%= t 'admin.dashboard.total_cash_on_hand' %></div>
              <div id="total-sales-breakdown" class="text-highlight font-weight-bold mb-0"></div>
              <div class="text-normal mb-0"><%= t 'admin.dashboard.cogs' %>: <span id="total-cogs-breakdown" class="text-large font-weight-bold">Rp 0</span></div>
              <div class="text-normal mb-0"><%= t 'admin.dashboard.profit' %>: <span id="total-profit-breakdown" class="text-large font-weight-bold">Rp 0</span></div>
              <div class="text-normal mb-0"><%= t 'admin.dashboard.down_payment' %>: <span id="total-down_payment_amount-breakdown" class="text-large font-weight-bold">Rp 0</span></div>
            </div>
            <div class="col-4">
              <%= select :revenue_aggregation_unit, :type, aggregationUnitArray(), {}, {class: 'form-control unavailable-btn'} %>
            </div>
          </div>
          <div class="mb-5">
            <canvas id="revenueBarChart" style="height: 350px; width: 100%;" class="chartjs-render-monitor"></canvas>
          </div>
          <div id="revenueLegend"></div>
        </div>
        <div class="tab-pane fade" id="profit" role="tabpanel" aria-labelledby="profit-tab">
          <div class="row pb-5 pt-4">
            <div class="col-8">
              <div class="text-normal"><%= t 'admin.dashboard.profit_by_product' %></div>
              <div id="total-profit" class="text-highlight font-weight-bold mb-0"></div>
            </div>
            <div class="col-4">
              <%= select :profit_aggregation_unit, :type, aggregationUnitArray(), {}, {class: 'form-control unavailable-btn'} %>
            </div>
          </div>
          <div class="pb-5 mb-4">
            <canvas id="profitBarChart" style="height: 350px; width: 100%;" class="chartjs-render-monitor"></canvas>
          </div>
        </div>
        <div class="tab-pane fade" id="expenses" role="tabpanel" aria-labelledby="expenses-tab">
          <div class="row pb-5 pt-4">
            <div class="col-8">
              <div class="text-normal">Total Pengeluaran</div>
              <div id="total-expenses-breakdown" class="text-highlight font-weight-bold mb-0"></div>
            </div>
            <div class="col-4">
              <%= select :expenses_aggregation_unit, :type, aggregationUnitArray(), {}, {class: 'form-control unavailable-btn'} %>
            </div>
          </div>
          <div class="pb-5 mb-4">
            <canvas id="expensesBarChart" style="height: 350px; width: 100%;" class="chartjs-render-monitor"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%# TRANSACTION SUMMARY %>
  <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
      <span class="text-large"><%= t 'admin.dashboard.checkin_summary' %></span>
      <button class="text-label scroll-up-btn d-flex justify-content-center align-items-center">
        <span class='mr-2 date-range-readonly'></span><i class='fas fa-arrow-up'></i>
      </button>
    </div>
    <div class="loading-wrapper">
      <div class="row pb-5">
        <div class="col-8">
          <div class="text-normal"><%= t 'admin.dashboard.total_transactions' %></div>
          <div id="total-checkins" class="text-highlight font-weight-bold mb-0"></div>
        </div>
        <div class="col-4">
          <%= select :checkins_aggregation_unit, :type, aggregationUnitArray(), {}, {class: 'form-control unavailable-btn'} %>
        </div>
      </div>
      <div>
        <canvas id="checkinsBarChart" style="height: 350px; width: 100%;" class="chartjs-render-monitor"></canvas>
      </div>
    </div>
  </div>
<% end %>
<!-- end form_tag -->

<%# MECHANIC REPORT %>
<div class="card">
  <div class="d-flex justify-content-between align-items-center p-3 mb-2">
    <span class="text-large"><%= t 'admin.dashboard.mechanic_report' %></span>
    <button class="text-label scroll-up-btn d-flex justify-content-center align-items-center">
      <span class='mr-2 date-range-readonly'></span><i class='fas fa-arrow-up'></i>
    </button>
  </div>
  <div class="loading-wrapper">
    <div class="table-responsive">  
      <table class="table">
        <thead class="thead-light">
          <tr class="text-label">
            <th class="align-top"><%= t 'admin.common.mechanic' %></th>
            <th class="align-top text-right"><%= t 'admin.dashboard.total_rp' %></th>
            <th class="align-top text-right"><%= t 'admin.dashboard.product' %></th>
            <th class="align-top text-right"><%= t 'admin.dashboard.product_rp' %></th>
            <th class="align-top text-right"><%= t 'admin.dashboard.service' %></th>
            <th class="align-top text-right"><%= t 'admin.dashboard.service_rp' %></th>
            <th class="align-top text-right"><%= t 'admin.common.show' %></th>
          </tr>
        </thead>
        <tbody id="mechanic-details-tbody">
        </tbody>
      </table>
    </div>
  </div>
</div>

<%# PAYMENT TYPE %>
<div class="card">
  <div class="d-flex justify-content-between align-items-center p-3 mb-2">
    <span class="text-large"> <%= t 'admin.dashboard.sales_payment_type' %> </span>
    <button class="text-label scroll-up-btn d-flex justify-content-center align-items-center">
      <span class='mr-2 date-range-readonly'></span><i class='fas fa-arrow-up'></i>
    </button>
  </div>
  <div class="loading-wrapper">
    <table class="table">
      <thead class="thead-light">
        <tr class="text-label">
          <th><%= t 'admin.dashboard.payment_type' %></th>
          <th class="text-right"><%= t 'admin.common.total' %></th>
        </tr>
      </thead>
      <tbody id="sales-by-type-tbody">
      </tbody>
    </table>
  </div>
</div>

